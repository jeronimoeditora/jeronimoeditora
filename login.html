<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conta | Iniciar Sessão ou Criar Conta</title>
    
    <!-- Google Fonts: Playfair Display (Serif) & Roboto (Sans) & Crimson Text (Classic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,900&family=Roboto:wght@300;400;500;700;900&family=Crimson+Text:ital,wght@0,400;0,700;1,1400;1,900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Roboto"', 'sans-serif'],
                        classic: ['"Crimson Text"', 'serif'],
                    },
                    colors: {
                        'brand-bg': '#F8F8F8', // Papel envelhecido moderno (Off-White)
                        'brand-text': '#333333', // Cinza Antracite
                        'brand-accent-red': '#800000', // Bordô/Vinho (Principal)
                        'brand-accent-blue': '#002147', // Azul Marinho Clássico (Secundário)
                        'brand-gold': '#cfaf5c', // Dourado Elegante (Cor customizada)
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos de input focados para melhor UX */
        input:focus {
            border-color: #800000 !important; /* brand-accent-red */
            box-shadow: 0 0 0 2px rgba(128, 0, 0, 0.2);
        }
        /* Ajuste para garantir que a main centraliza o conteúdo em todas as alturas */
        main {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Estilos para a página de perfil */
        .profile-card {
            background-image: linear-gradient(to bottom, #002147, #001a35);
        }
        /* Estilos para as tabs (abas) */
        .tab-button.active {
            border-color: #800000;
            color: #800000;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-brand-bg text-brand-text font-sans antialiased flex flex-col min-h-screen">
    
    <!-- Modal para Favoritos (ADICIONADO) -->
    <div id="favorites-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full mx-4 transform transition-all duration-300 scale-95 max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold font-serif text-brand-accent-blue mb-4 border-b pb-2">Os Seus Favoritos</h3>
            
            <div id="favorites-list" class="flex-grow p-5 overflow-y-auto space-y-4 pr-2">
                <!-- Conteúdo dos favoritos será injetado aqui -->
                <p id="empty-favorites-message" class="text-gray-500 italic text-center py-4">Ainda não tem livros favoritos. Marque o coração nas capas para os adicionar!</p>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                <button onclick="closeFavorites()" class="bg-brand-accent-red text-white py-2 px-6 rounded-md hover:bg-red-900 transition-colors shadow-lg">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Navbar Fixa (Simplificada para a página de login/perfil) -->
    <nav class="w-full bg-white shadow-md border-b border-gray-100 py-4 px-6 fixed top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            
            <!-- Logótipo e Nome da Editora -->
            <a href="index.html" class="flex items-center space-x-2">
                <img 
                    src="Logo J.png" 
                    alt="Logótipo Jerónimo Editora" 
                    class="h-9 w-auto"
                    onerror="this.onerror=null;this.src='https://placehold.co/40x40/cfaf5c/800000?text=J';"
                />
                <span class="font-serif text-2xl font-extrabold text-brand-text hover:text-brand-accent-red transition-colors duration-200">Jerónimo Editora</span>
            </a>
            
            <!-- Menu de Retorno (Simplificado, apenas para desktop) -->
            <a href="index.html" class="hidden md:flex items-center space-x-2 text-sm font-medium text-gray-700 hover:text-brand-accent-red transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                <span>Voltar à Loja</span>
            </a>
            
            <!-- Placeholder do ÍCONE/NOME DA CONTA DESKTOP (Usado para login/logout) -->
            <a id="user-nav-link" href="login.html" class="pl-4 text-gray-700 hover:text-brand-accent-red transition-colors duration-200 hidden md:block" aria-label="Aceder à Conta">
                <!-- Conteúdo gerado por JavaScript (renderUserNav) -->
            </a>

            <!-- Botão Menu Mobile -->
            <button id="menu-button" class="md:hidden text-2xl text-brand-text focus:outline-none hover:text-brand-accent-red">
                &#9776;
            </button>
        </div>
    </nav>
    
    <!-- Menu Mobile Deslizante (ESTRUTURA COMPLETA E DINÂMICA) -->
    <div id="mobile-menu" class="hidden fixed top-20 left-0 w-full bg-white shadow-xl z-40 md:hidden">
        <div class="flex flex-col p-4 text-center space-y-3">
            <a href="index.html#hero" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">INÍCIO</a>
            <a href="catalogo-completo.html" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">CATÁLOGO</a>
            <a href="infantil.html" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">INFANTIL</a>
            <a href="produtos.html" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">PRODUTOS</a>
            <a href="index.html#sobre" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">SOBRE</a>
            <a href="contato.html" class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">CONTATO</a>

            <!-- Ícones de Carrinho e Favoritos (ADICIONADOS) -->
            <div class="flex justify-center space-x-8 pt-4 border-t border-gray-100">
                <!-- Ícone Favoritos Mobile -->
                <button class="relative text-gray-700 hover:text-brand-accent-red transition-colors" onclick="openFavorites(); toggleMenu();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    <span id="fav-count-mobile" class="absolute -top-1 -right-2 bg-brand-accent-red text-white text-xs font-bold w-4 h-4 flex items-center justify-center rounded-full opacity-0 scale-0 transition-all duration-300">0</span>
                </button>
                <!-- Ícone Carrinho Mobile -->
                <a href="checkout.html" class="relative text-gray-700 hover:text-brand-accent-red transition-colors" onclick="toggleMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="20" r="1"/><circle cx="17" cy="20" r="1"/><path d="M2.5 2.5h2l2 11h11l1-6h5.5"/><path d="m20.5 7-1.4 5.2a1 1 0 0 1-.95.8H7.5"/><path d="M8 8h9"/><path d="M17 17H7.5"/></svg>
                    <span id="cart-count-mobile" class="absolute -top-1 -right-2 bg-brand-accent-red text-white text-xs font-bold w-4 h-4 flex items-center justify-center rounded-full opacity-0 scale-0 transition-all duration-300">0</span>
                </a>
            </div>

            <!-- Link de Conta no Mobile (AGORA DINÂMICO) -->
            <a 
                id="user-nav-link-mobile" 
                href="login.html" 
                class="py-2 text-gray-700 hover:bg-gray-100 hover:text-brand-accent-red transition-colors font-bold flex items-center justify-center space-x-2" 
                onclick="toggleMenu()"
                aria-label="Aceder à Conta"
            >
                <!-- Conteúdo será preenchido por renderUserNav() -->
            </a>
        </div>
    </div>


    <!-- Main Content: Login/Criação de Conta ou Perfil -->
    <main id="main-content" class="flex-grow pt-24 pb-12">
        <!-- Conteúdo do Formulário de Autenticação (CLASSE 'hidden' REMOVIDA) -->
        <div id="auth-view" class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border border-gray-100 mx-4">
            
            <h1 class="font-serif text-3xl text-brand-accent-red mb-6 text-center">Aceder ou Criar Conta</h1>
            
            <!-- Mensagem de Alerta -->
            <div id="auth-message" class="p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden mb-4 font-medium" role="alert">
                Aviso: A autenticação é apenas uma simulação no momento.
            </div>

            <!-- OPÇÃO 1: Botão Google (SSO) -->
            <button 
                id="google-login-btn"
                onclick="handleGoogleLogin()"
                class="w-full flex items-center justify-center space-x-3 bg-brand-accent-blue text-white py-3 rounded-lg hover:bg-blue-900 transition-colors shadow-md mb-4 font-bold text-lg"
            >
                <!-- SVG do Google (Simulação) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 bg-white rounded-full p-0.5" viewBox="0 0 48 48" fill="none">
                    <path fill="#FFC107" d="M43.61 20.083H42V20H24v8h11.346c-1.157 3.447-4.14 6-7.85 6-4.954 0-8.982-4.032-8.982-8.984 0-4.952 4.028-8.98 8.982-8.98 2.395 0 4.545 0.985 6.094 2.574l5.657-5.657C34.046 6.065 29.268 4 24.002 4 12.95 4 4 12.95 4 24s8.95 20 20.002 20 20-8.95 20-20c0-1.346-0.138-2.65-0.388-3.917z" />
                    <path fill="#FF3D00" d="M6.307 14.693l6.57 5.238C14.86 19.4 16.517 18.25 18.498 18.25c4.954 0 8.982 4.032 8.982 8.984 0 4.952-4.028 8.98-8.982 8.98-2.395 0-4.545-0.985-6.094-2.574L6.307 33.307C8.61 37.032 13.065 40 18.498 40c5.266 0 10.044-2.065 13.666-5.657l-5.657-5.657C24.718 31.015 22.568 32 20.002 32c-4.954 0-8.982-4.032-8.982-8.984 0-4.952 4.028-8.98 8.982-8.98 2.395 0 4.545 0.985 6.094 2.574l5.657-5.657C34.046 6.065 29.268 4 24.002 4 12.95 4 4 12.95 4 24s8.95 20 20.002 20 20-8.95 20-20c0-1.346-0.138-2.65-0.388-3.917z" transform="translate(-4, -4)" />
                    <path fill="#4CAF50" d="M14.693 35.307l6.57-5.238C20.4 33.015 22.057 34.165 24.038 34.165c4.954 0 8.982-4.032 8.982-8.984 0-4.952-4.028-8.98-8.982-8.98-2.395 0-4.545-0.985-6.094-2.574L14.693 23.307C17 27.032 21.455 30 26.888 30c5.266 0 10.044-2.065 13.666-5.657l-5.657-5.657C33.718 20.015 31.568 21 29.002 21c-4.954 0-8.982-4.032-8.982-8.984 0-4.952 4.028-8.98 8.982-8.98 2.395 0 4.545-0.985 6.094-2.574l5.657 5.657C34.046 6.065 29.268 4 24.002 4 12.95 4 4 12.95 4 24s8.95 20 20.002 20 20-8.95 20-20c0-1.346-0.138-2.65-0.388-3.917z" transform="translate(-4, -4)" />
                    <path fill="#4285F4" d="M43.61 20.083h-1.61c-0.25 1.267-0.388 2.571-0.388 3.917 0 11.05 8.95 20 20.002 20s20-8.95 20-20S35.052 4 24.002 4c-5.266 0-10.044 2.065-13.666 5.657l5.657 5.657C22.568 10.985 24.718 10 27.252 10c4.954 0 8.982 4.032 8.982 8.984 0 4.952-4.028 8.98-8.982 8.98-2.395 0-4.545-0.985-6.094-2.574l-5.657 5.657C14.956 37.935 19.734 40 25.002 40c11.052 0 20-8.95 20-20 0-1.346-0.138-2.65-0.388-3.917z" transform="translate(-4, -4)" />
                </svg>
                <span>Continuar com Google</span>
            </button>

            <!-- Divisor "ou" -->
            <div class="flex items-center my-6">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-500 text-sm font-semibold">OU</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>

            <!-- OPÇÃO 2: Formulário Email e Password -->
            <form id="email-form" onsubmit="handleEmailAuth(event)">
                
                <h2 class="font-serif text-xl text-brand-text mb-4 text-center border-b border-gray-100 pb-2">Aceder com Email</h2>
                
                <div class="space-y-4">
                    <!-- Campo de Nome (Visível apenas no modo Registo) -->
                    <div id="name-field" class="hidden">
                        <label for="name" class="block text-sm font-medium text-gray-700">Nome Completo *</label>
                        <input type="text" id="name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                        <input type="email" id="email" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">
                            Password *
                            <!-- Aviso de Requisitos de Password (Apenas visível no modo Registo) -->
                            <span id="password-req-text" class="text-xs text-gray-500 font-normal ml-2 hidden">
                                (Mín. 8 chars, 1 Maiúscula, 1 Símbolo)
                            </span>
                        </label>
                        <input type="password" id="password" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-50">
                    </div>
                </div>
                
                <button type="submit" id="auth-submit-btn" class="w-full bg-brand-accent-red text-white font-bold py-3 mt-6 rounded-lg hover:bg-red-900 transition-colors shadow-xl text-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Iniciar Sessão
                </button>
            </form>
            
            <div class="mt-6 text-center space-y-3 pt-4 border-t border-gray-100">
                <!-- Links para Ações -->
                <button onclick="toggleAuthMode(true)" id="toggle-signup-btn" class="text-sm font-medium text-brand-accent-blue hover:text-brand-accent-red underline transition-colors">
                    Não tem conta? Crie uma agora!
                </button>
                <br>
                <button onclick="showCustomAlert('Recuperação de Password', 'Esta função enviaria um link de recuperação para o seu email (e.g., via Firebase).')" class="text-xs text-gray-500 hover:text-brand-accent-red underline transition-colors">
                    Esqueceu-se da Password?
                </button>
            </div>
        </div>
        
        <!-- Conteúdo do Perfil (Oculto inicialmente) -->
        <!-- NOVO LAYOUT DO PERFIL COM ABAS -->
        <div id="profile-view" class="max-w-4xl w-full p-6 rounded-xl shadow-2xl mx-4 hidden bg-white">
            
            <!-- Header do Perfil -->
            <div class="profile-card p-6 rounded-xl shadow-lg text-white mb-6 flex items-center space-x-4">
                <div class="h-16 w-16 bg-brand-gold text-brand-accent-blue rounded-full flex items-center justify-center text-3xl font-extrabold font-serif border-4 border-white shadow-xl flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4a4 4 0 0 0-4 4v.5a4 4 0 0 0 4 4 4 4 0 0 0 4-4V8a4 4 0 0 0-4-4zM2 20a10 10 0 0 1 20 0z"/></svg>
                </div>
                <div>
                    <h1 class="font-serif text-3xl font-bold text-white">
                        Bem-vindo, <span id="user-name">Utilizador</span>!
                    </h1>
                    <p id="user-email" class="text-gray-300 font-sans text-sm italic"></p>
                </div>
                <button 
                    onclick="handleLogout()"
                    class="ml-auto bg-brand-accent-red text-white font-bold py-2 px-4 rounded-lg hover:bg-red-900 transition-colors shadow-lg flex-shrink-0"
                >
                    Terminar Sessão
                </button>
            </div>

            <!-- Navegação por Abas (Tabs) -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-6">
                    <button onclick="showProfileTab('detalhes')" id="tab-detalhes" class="tab-button active py-2 px-1 text-sm font-medium border-b-2 border-brand-accent-red text-brand-accent-red transition-colors">
                        Detalhes da Conta
                    </button>
                    <button onclick="showProfileTab('encomendas')" id="tab-encomendas" class="tab-button py-2 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 transition-colors">
                        Histórico de Encomendas
                    </button>
                    <!-- A aba Favoritos NÃO ativa o modal diretamente, apenas o botão no conteúdo -->
                    <button onclick="showProfileTab('favoritos')" id="tab-favoritos" class="tab-button py-2 px-1 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:border-gray-300 transition-colors">
                        Favoritos (<span id="profile-fav-count-tab">0</span>)
                    </button>
                </nav>
            </div>

            <!-- Conteúdo das Abas -->
            <div id="profile-content-container">
                
                <!-- Conteúdo 1: Detalhes da Conta (Padrão) -->
                <div id="content-detalhes" class="profile-tab-content space-y-6">
                    <h2 class="font-serif text-2xl text-brand-accent-blue mb-4">Gerir Informação Pessoal</h2>
                    
                    <!-- Secção de Moradas e Nome -->
                    <form id="details-form" onsubmit="handleDetailsUpdate(event)" class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                        
                        <!-- Nome Completo -->
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="profile-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" value="" required> <!-- VALOR REMOVIDO -->
                        </div>
                        
                        <!-- Email (Não Editável) -->
                        <div>
                            <label for="profile-email" class="block text-sm font-medium text-gray-700">Email (Não Editável)</label>
                            <input type="email" id="profile-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-gray-200" value="N/A" disabled>
                        </div>

                         <!-- Morada de Envio (SIMULAÇÃO) -->
                        <div class="pt-2 border-t border-gray-200">
                            <label for="profile-shipping-address" class="block text-sm font-medium text-gray-700">Morada de Envio</label>
                            <input type="text" id="profile-shipping-address" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Rua, Código Postal, Cidade" value=""> <!-- VALOR REMOVIDO -->
                            <p class="text-xs text-gray-500 mt-1">Morada usada para envio das encomendas.</p>
                        </div>
                        
                        <!-- Morada de Faturação (SIMULAÇÃO) -->
                        <div>
                            <label for="profile-billing-address" class="block text-sm font-medium text-gray-700">Morada de Faturação</label>
                            <input type="text" id="profile-billing-address" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Opcional, se diferente da morada de envio" value=""> <!-- VALOR REMOVIDO -->
                        </div>

                        <!-- Botão de Guardar Alterações -->
                        <button type="submit" id="save-details-btn" class="bg-brand-gold text-brand-accent-blue font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition-colors shadow-md">
                            Guardar Alterações
                        </button>
                    </form>
                    
                    <!-- Secção de Alteração de Password -->
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="font-serif text-xl text-brand-accent-red mb-3">Alterar Password</h3>
                        <form onsubmit="handlePasswordChange(event)" class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                            
                            <!-- Password Atual (Para confirmação) -->
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700">Password Atual</label>
                                <input type="password" id="current-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>

                            <!-- Nova Password -->
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Password</label>
                                <input type="password" id="new-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" required>
                                <p id="password-req-message" class="text-xs text-gray-500 mt-1">Mín. 8 chars, 1 Maiúscula, 1 Símbolo.</p>
                            </div>
                            
                            <!-- Repetir Nova Password -->
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirmar Nova Password</label>
                                <input type="password" id="confirm-password" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm" required>
                            </div>

                            <button type="submit" id="change-password-btn" class="bg-brand-accent-blue text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-900 transition-colors shadow-md">
                                Alterar Password
                            </button>
                            <p id="password-change-message" class="text-sm font-semibold hidden pt-2"></p>
                        </form>
                    </div>
                </div>

                <!-- Conteúdo 2: Histórico de Encomendas -->
                <div id="content-encomendas" class="profile-tab-content hidden">
                    <h2 class="font-serif text-2xl text-brand-accent-blue mb-4">Suas Últimas Encomendas</h2>
                    
                    <div id="orders-list" class="space-y-4">
                        <!-- Lista de Encomendas (Mock) -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-brand-text">#ENCOMENDA-2025-0042</p>
                                <p class="text-sm text-gray-600">1 Item | 15/12/2025 | Total: 99,50€</p>
                            </div>
                            <p class="text-xs text-green-600 font-semibold flex-shrink-0 bg-green-200 px-2 py-1 rounded-full">Enviado</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-brand-text">#ENCOMENDA-2025-0018</p>
                                <p class="text-sm text-gray-600">3 Itens | 03/11/2025 | Total: 42,90€</p>
                            </div>
                            <p class="text-xs text-brand-accent-red font-semibold flex-shrink-0 bg-red-200 px-2 py-1 rounded-full">Cancelado</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                            <div>
                                <p class="font-bold text-brand-text">#ENCOMENDA-2025-0001</p>
                                <p class="text-sm text-gray-600">2 Itens | 05/10/2025 | Total: 29,49€</p>
                            </div>
                            <p class="text-xs text-brand-accent-blue font-semibold flex-shrink-0 bg-blue-200 px-2 py-1 rounded-full">Entregue</p>
                        </div>
                        <p class="text-sm text-gray-500 italic pt-2">O seu histórico completo é mantido em segurança.</p>
                    </div>
                </div>

                <!-- Conteúdo 3: Favoritos -->
                <div id="content-favoritos" class="profile-tab-content hidden">
                    <h2 class="font-serif text-2xl text-brand-accent-blue mb-4">Os Seus Livros Favoritos</h2>
                    <p class="text-gray-700 mb-4">Todos os itens que marcou com o coração em todo o nosso catálogo. Clique abaixo para gerir ou navegar até eles.</p>
                    <!-- Este botão APENAS abre o modal. -->
                    <button 
                        onclick="openFavorites()" 
                        class="bg-brand-accent-red text-white py-2 px-6 rounded-lg hover:bg-red-900 transition-colors font-bold shadow-md"
                    >
                        Ver Lista Completa
                    </button>
                </div>

            </div>
        </div>
        
    </main>

    <!-- FOOTER (Simplificado) -->
    <footer class="bg-gray-900 text-gray-300 py-6 px-6 border-t-4 border-brand-accent-red">
        <div class="max-w-6xl mx-auto text-center">
            <p class="text-xs text-gray-500">© 2025 Jerónimo Editora. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script>
        // Variável de estado para alternar entre Login e Registo (true = Registo)
        let isSignUpMode = false; 
        const USER_STORAGE_KEY = 'currentUser';
        const REGISTERED_USERS_KEY = 'registeredEmails';
        
        // Dados MOCK de todos os livros (NECESSÁRIO para renderizar a modal de favoritos)
        const bookData = [
            { id: 1, title: "Suma Teológica", author: "São Tomás de Aquino", price: 75.00, image: "suma_teologica.png", link: "detalhes.html" },
            { id: 2, title: "Jesus e o Jubileu", author: "John S. Bergsma", price: 34.90, image: "Bergsma.png", link: "detalhes.html" },
            { id: 3, title: "Tu podes entender a Bíblia", author: "Peter Kreeft", price: 24.99, image: "Kreeft.png", link: "detalhes.html" },
            { id: 101, title: "O Meu Primeiro Livro da Bíblia", author: "Equipa Jerónimo Kids", price: 12.50, image: "https://placehold.co/128x192/FFD700/800000?text=BÍBLIA+KIDS", link: "infantil.html" },
            { id: 201, title: "Marcador de Livros em Pele (Cordeiro)", author: "Artesanato Local", price: 12.00, image: "https://placehold.co/128x192/4B4B4B/cfaf5c?text=MARCADOR", link: "produtos.html" },
            { id: 4, title: "Convite aos Salmos", author: "Rolf A. Jacobson & Karl N. Jacobson", price: 28.50, image: "Jacobson.png", link: "detalhes.html" },
            { id: 5, title: "São Francisco de Sales - Doutor da Perfeição", author: "Abbé Jacques Leclercq", price: 28.00, image: "Abbe.png", link: "detalhes.html" },
            { id: 6, title: "As mãos vazias - Mensagem de Santa Teresa do Menino Jesus", author: "Conrad de Meester", price: 28.00, image: "Teresinha.png", link: "detalhes.html" },
        ];
        
        /**
         * Obtém os dados do livro, tratando IDs numéricos e chaves especiais.
         */
        function getBookDataById(id) {
            const idNum = parseInt(id);
            if (idNum === 1 || id === 'suma-teologica') {
                 return bookData.find(book => book.id === 1) || null;
            }
            return bookData.find(book => book.id === idNum) || null;
        }
        
        function formatPrice(price) {
            return `€ ${price.toFixed(2).replace('.', ',')}`;
        }
        
        // --- Funções de Validação ---
        
        function validatePassword(password) {
            // Requisitos: Mín. 8 chars, 1 Maiúscula, 1 Símbolo
            const regex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
            return regex.test(password);
        }

        // --- Funções de Alerta (Substitui alert() para UX) ---
        function showCustomAlert(title, message, isError = false) {
             const modal = document.createElement('div');
             modal.className = 'fixed inset-0 z-[100] bg-black bg-opacity-70 flex items-center justify-center';
             const iconSvg = isError 
                 ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 22h16a2 2 0 0 0 1.73-4Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>'
                 : '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>';

            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center">
                    ${iconSvg}
                    <h4 class="text-xl font-bold text-brand-accent-blue mb-3">${title}</h4>
                    <p class="text-gray-700 mb-4">${message}</p>
                    <button onclick="this.parentNode.parentNode.remove()" class="bg-brand-accent-red text-white py-2 px-6 rounded-lg hover:bg-red-900 transition-colors font-semibold">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // --- Funções de Favoritos (Integração) ---
        
        function updateFavoritesCount() {
            let count = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('fav-') && localStorage.getItem(key) === 'true') {
                    count++;
                }
            }
            // Atualiza o contador no botão do perfil
            const profileFavCount = document.getElementById('profile-fav-count-tab');
            if(profileFavCount) {
                profileFavCount.textContent = count;
            }
            // Atualiza os contadores do menu mobile
             document.querySelectorAll('#fav-count-mobile').forEach(el => {
                el.textContent = count;
                el.classList.toggle('opacity-0', count === 0);
                el.classList.toggle('scale-0', count === 0);
            });
            
            return count;
        }

        function renderFavoritesList() {
            const favListContainer = document.getElementById('favorites-list');
            const favMsg = document.getElementById('empty-favorites-message');
            
            let favItemsHtml = '';
            let favCount = 0;

            const favoriteKeys = Object.keys(localStorage).filter(key => key.startsWith('fav-') && localStorage.getItem(key) === 'true');

            favoriteKeys.forEach(key => {
                const simulatedId = key.replace('fav-', '');
                const bookId = simulatedId === 'suma-teologica' ? 1 : parseInt(simulatedId); 
                const book = getBookDataById(bookId);
                
                const removalKey = (bookId === 1 && simulatedId === 'suma-teologica') ? 'suma-teologica' : bookId; 

                if (book) {
                    favCount++;
                    const priceFormatted = formatPrice(book.price);
                    
                    favItemsHtml += `
                        <div class="flex items-center space-x-4 p-3 border border-gray-100 rounded-lg bg-gray-50 shadow-inner">
                            <a href="${book.link}" class="flex items-center space-x-4 flex-grow hover:bg-gray-100 p-2 rounded-lg transition-colors">
                                <img 
                                    src="${book.image}" 
                                    alt="Capa do Livro ${book.title}" 
                                    class="w-16 h-24 object-contain rounded-sm flex-shrink-0" 
                                    onerror="this.onerror=null;this.src='https://placehold.co/64x96/002147/cfaf5c?text=CAPA';"
                                />
                                <div class="flex-grow">
                                    <h4 class="font-serif font-bold text-brand-text">${book.title}</h4>
                                    <p class="text-sm text-gray-500 italic mb-1">${book.author}</p>
                                    <p class="font-classic font-extrabold text-lg text-brand-accent-red">${priceFormatted}</p>
                                </div>
                            </a>
                            
                            <!-- Botão de Remoção Rápida: Chama toggleFavorite com isModalRemoval=true -->
                            <button 
                                onclick="toggleFavorite('${removalKey}', true)"
                                class="p-2 text-gray-400 hover:text-red-600 transition-colors flex-shrink-0"
                                aria-label="Remover dos favoritos"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                    `;
                }
            });
            
            favListContainer.innerHTML = favItemsHtml;
            favMsg.classList.toggle('hidden', favCount > 0);
        }

        function openFavorites() {
            renderFavoritesList();
            document.getElementById('favorites-modal').classList.remove('hidden');
        }

        function closeFavorites() {
            document.getElementById('favorites-modal').classList.add('hidden');
        }

        /**
         * Adiciona/Remove um item dos favoritos.
         */
        function toggleFavorite(productIdOrKey, isModalRemoval = false) {
            const key = productIdOrKey == 1 ? 'fav-suma-teologica' : `fav-${productIdOrKey}`; 
            const isFav = localStorage.getItem(key) === 'true';
            
            let productTitle = 'Produto';
            const product = getBookDataById(productIdOrKey);
            if(product) {
                productTitle = product.title;
            } else if (productIdOrKey === 'suma-teologica') {
                productTitle = 'Suma Teológica';
            }


            if (isFav) {
                localStorage.removeItem(key);
                showCustomAlert("Removido", `O produto "${productTitle}" foi removido dos seus Favoritos.`);
                
                if (isModalRemoval) {
                    renderFavoritesList();
                }
            } else {
                localStorage.setItem(key, 'true');
                showCustomAlert("Adicionado aos Favoritos", `O produto "${productTitle}" está agora nos seus Favoritos!`);
            }
            
            updateFavoritesCount(); // Atualiza contagem do botão no perfil
        }


        // --- Funções de Estado e Visualização ---

        function getRegisteredEmails() {
            const initialEmails = ['utilizador.teste@exemplo.com', 'google.teste@exemplo.com'];
            let registered = JSON.parse(localStorage.getItem(REGISTERED_USERS_KEY));
            
            if (!registered) {
                registered = initialEmails;
                localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(initialEmails));
            }
            return registered;
        }

        function registerNewEmail(email) {
            const emails = getRegisteredEmails();
            if (!emails.includes(email.toLowerCase())) {
                 emails.push(email.toLowerCase());
                 localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(emails));
            }
        }
        
        /**
         * Renders the user status (name or icon) in the navigation bar.
         */
        function renderUserNav() {
            const userNavElement = document.getElementById('user-nav-link');
            const userNavMobileElement = document.getElementById('user-nav-link-mobile');
            
            const user = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || 'null');
            
            // Ícone de Perfil
            const iconHtml = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
            `;

            if (user && user.isLoggedIn) {
                const firstName = user.name ? user.name.split(' ')[0] : 'Utilizador';
                const loggedInHtml = `<span class="font-bold hover:text-red-900 transition-colors">Olá, ${firstName}!</span>`;
                const loggedInMobileHtml = `${iconHtml} <span class="font-bold">Perfil</span>`;

                // Aplica ao Desktop
                if (userNavElement) {
                    userNavElement.href = 'login.html'; 
                    userNavElement.classList.remove('pl-4', 'text-gray-700'); 
                    userNavElement.classList.add('font-bold', 'text-brand-accent-red');
                    userNavElement.innerHTML = loggedInHtml;
                    userNavElement.classList.remove('hidden'); // Certifica que está visível no desktop
                }
                
                // Aplica ao Mobile
                if (userNavMobileElement) {
                    userNavMobileElement.href = 'login.html';
                    userNavMobileElement.classList.remove('text-gray-700');
                    userNavMobileElement.classList.add('text-brand-accent-red');
                    userNavMobileElement.innerHTML = loggedInMobileHtml;
                }

            } else {
                // Não logado (ícone no desktop, ícone + texto "CONTA" no mobile para clareza)

                // Aplica ao Desktop (só ícone)
                if (userNavElement) {
                    userNavElement.href = 'login.html';
                    userNavElement.classList.add('pl-4', 'text-gray-700');
                    userNavElement.classList.remove('font-bold', 'text-brand-accent-red');
                    userNavElement.innerHTML = iconHtml;
                     userNavElement.classList.remove('hidden'); // Certifica que está visível no desktop
                }
                
                // Aplica ao Mobile (ícone + CONTA)
                 if (userNavMobileElement) {
                    userNavMobileElement.href = 'login.html';
                    userNavMobileElement.classList.add('text-gray-700', 'font-bold');
                    userNavMobileElement.classList.remove('text-brand-accent-red');
                    userNavMobileElement.innerHTML = `${iconHtml} <span>CONTA</span>`;
                }
            }
             // Oculta a div 'Voltar à Loja' no mobile (não é relevante nesta página)
             const mobileMenu = document.getElementById('mobile-menu');
             if (mobileMenu) {
                mobileMenu.classList.add('hidden');
             }
        }

        /**
         * Verifica se existe um utilizador autenticado e mostra a vista correta.
         */
        function checkAuthStatus() {
            const user = JSON.parse(localStorage.getItem(USER_STORAGE_KEY));
            const authView = document.getElementById('auth-view');
            const profileView = document.getElementById('profile-view');

            if (user && user.isLoggedIn) {
                authView.classList.add('hidden');
                profileView.classList.remove('hidden');
                showProfileView(user);
                renderUserNav(); 
                updateFavoritesCount(); // Atualiza a contagem no botão do perfil
                showProfileTab('detalhes'); // Garante que a primeira aba é mostrada
            } else {
                // O authView agora é visível por padrão no HTML, então só escondemos o profileView
                authView.classList.remove('hidden');
                profileView.classList.add('hidden');
                // Assegura que o formulário está no modo Login (padrão)
                toggleAuthMode(false); 
                renderUserNav(); 
            }
        }

        /**
         * Renderiza a vista do perfil com os dados do utilizador.
         */
        function showProfileView(user) {
            // Usa o nome guardado ou "Utilizador" se for null/undefined
            document.getElementById('user-name').textContent = user.name || 'Utilizador';
            document.getElementById('user-email').textContent = user.email || 'N/A';
            
            // Popula os campos do formulário de detalhes (USANDO OS VALORES DO USER OU STRING VAZIA)
            const profileNameInput = document.getElementById('profile-name');
            const profileEmailInput = document.getElementById('profile-email');
            const profileShippingAddressInput = document.getElementById('profile-shipping-address');
            const profileBillingAddressInput = document.getElementById('profile-billing-address');


            if (profileNameInput) profileNameInput.value = user.name || '';
            if (profileEmailInput) profileEmailInput.value = user.email || 'N/A';
            // Os valores de morada devem vir do objeto user (que estarão vazios se for um novo login)
            if (profileShippingAddressInput) profileShippingAddressInput.value = user.shippingAddress || '';
            if (profileBillingAddressInput) profileBillingAddressInput.value = user.billingAddress || '';
            
            // Atualiza a contagem de favoritos na aba
            document.getElementById('profile-fav-count-tab').textContent = updateFavoritesCount();
        }
        
        /**
         * Lógica para trocar o conteúdo das abas no perfil.
         */
        function showProfileTab(tabName) {
            // Remove 'active' de todos os botões e esconde o conteúdo
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-brand-accent-red', 'text-brand-accent-red');
                button.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300');
            });

            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Adiciona 'active' ao botão clicado e mostra o conteúdo
            const activeTabButton = document.getElementById(`tab-${tabName}`);
            const activeTabContent = document.getElementById(`content-${tabName}`);

            if (activeTabButton && activeTabContent) {
                 activeTabButton.classList.add('active', 'border-brand-accent-red', 'text-brand-accent-red');
                 activeTabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300');
                 activeTabContent.classList.remove('hidden');
            }
        }

        /**
         * Simula a atualização dos detalhes da conta (Nome e Moradas).
         */
        function handleDetailsUpdate(event) {
            event.preventDefault();
            
            const newName = document.getElementById('profile-name').value;
            const shippingAddress = document.getElementById('profile-shipping-address').value;
            const billingAddress = document.getElementById('profile-billing-address').value;
            const saveBtn = document.getElementById('save-details-btn');

            // Simulação de atualização do estado local
            const currentUser = JSON.parse(localStorage.getItem(USER_STORAGE_KEY));
            
            if (currentUser) {
                const updatedUser = { 
                    ...currentUser, 
                    name: newName,
                    shippingAddress: shippingAddress,
                    billingAddress: billingAddress
                };
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(updatedUser));
                
                // Atualiza a vista
                showProfileView(updatedUser);
                
                // Feedback visual: Visto verde
                saveBtn.innerHTML = '&#10003; Guardado';
                saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.remove('bg-brand-gold', 'hover:bg-yellow-600');
                
                setTimeout(() => {
                    saveBtn.innerHTML = 'Guardar Alterações';
                    saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    saveBtn.classList.add('bg-brand-gold', 'hover:bg-yellow-600');
                }, 2000);
            }
        }
        
        /**
         * Simula a alteração da password.
         */
        function handlePasswordChange(event) {
            event.preventDefault();
            
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const messageEl = document.getElementById('password-change-message');
            const form = event.target;
            
            messageEl.classList.remove('hidden', 'text-red-600', 'text-green-700');

            if (newPass !== confirmPass) {
                messageEl.textContent = 'Erro: A nova password e a confirmação não coincidem.';
                messageEl.classList.add('text-red-600');
                return;
            }

            if (!validatePassword(newPass)) {
                messageEl.textContent = 'Erro: A nova password não cumpre os requisitos de segurança.';
                messageEl.classList.add('text-red-600');
                return;
            }
            
            // Simulação de verificação da password atual
            if (currentPass.length < 5) { // Simulação simples
                messageEl.textContent = 'Erro: Password atual incorreta ou muito curta.';
                messageEl.classList.add('text-red-600');
                return;
            }

            // Sucesso Simulado
            messageEl.textContent = 'Password alterada com sucesso!';
            messageEl.classList.add('text-green-700');
            form.reset();
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }

        /**
         * Termina a sessão (simulação).
         */
        function handleLogout() {
            localStorage.removeItem(USER_STORAGE_KEY);
            showCustomAlert('Sessão Terminada', 'A sua sessão foi encerrada com sucesso. Volte em breve!');
            checkAuthStatus(); // Volta para a vista de Login
        }

        // --- Funções de Autenticação (SIMULAÇÃO) ---

        // Alterna entre Iniciar Sessão e Criar Conta
        function toggleAuthMode(newMode) {
            isSignUpMode = newMode; 
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleBtn = document.getElementById('toggle-signup-btn');
            const authMessage = document.getElementById('auth-message');
            const nameField = document.getElementById('name-field');
            const passwordReqText = document.getElementById('password-req-text');
            
            if (isSignUpMode) {
                submitBtn.textContent = 'Criar Conta';
                toggleBtn.innerHTML = 'Já tem conta? Inicie Sessão';
                authMessage.textContent = 'Modo: Criar Conta. (Simulação: Preencha o nome e email/password).';
                authMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'border-red-400');
                authMessage.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-400');
                document.querySelector('#auth-view h2.font-serif').textContent = 'Criar Conta com Email';
                nameField.classList.remove('hidden'); // Mostra o campo Nome
                passwordReqText.classList.remove('hidden'); // Mostra os requisitos de password
                document.getElementById('name').setAttribute('required', 'required'); // Torna o campo Nome obrigatório
            } else {
                submitBtn.textContent = 'Iniciar Sessão';
                toggleBtn.innerHTML = 'Não tem conta? Crie uma agora!';
                authMessage.textContent = 'Modo: Iniciar Sessão. (Simulação: qualquer email/password funciona).';
                authMessage.classList.remove('hidden', 'bg-blue-100', 'text-blue-700', 'border-blue-400');
                authMessage.classList.add('bg-red-100', 'text-red-700', 'border-red-400');
                document.querySelector('#auth-view h2.font-serif').textContent = 'Aceder com Email';
                nameField.classList.add('hidden'); // Esconde o campo Nome
                passwordReqText.classList.add('hidden'); // Esconde os requisitos de password
                document.getElementById('name').removeAttribute('required'); // Remove a obrigatoriedade
            }
            authMessage.classList.remove('hidden');
        }

        // Simulação do login/registo por email
        function handleEmailAuth(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nameInput = document.getElementById('name');
            const name = nameInput ? nameInput.value : '';
            const submitBtn = document.getElementById('auth-submit-btn');
            const registeredEmails = getRegisteredEmails();
            
            // 1. Validação de campos (mantida)
            if (isSignUpMode && (!email || !name)) {
                 showCustomAlert('Erro de Validação', 'Por favor, preencha o Nome, Email e Password.', true);
                 return;
            }
            if (!isSignUpMode && !email) {
                 showCustomAlert('Erro de Validação', 'Por favor, preencha o Email e Password.', true);
                 return;
            }
            
            // 2. Validação Única de Email (NOVA LÓGICA - Registo)
            if (isSignUpMode && registeredEmails.includes(email.toLowerCase())) {
                showCustomAlert('Email Duplicado', `O email "${email}" já se encontra registado. Por favor, inicie sessão ou use outro email.`, true);
                return;
            }
            
            // 3. Validação de Requisitos da Password (NOVA LÓGICA - Registo)
            if (isSignUpMode && !validatePassword(password)) {
                 showCustomAlert('Password Fraca', 'A password deve ter no mínimo 8 caracteres, incluir pelo menos uma letra maiúscula e um caractere especial (e.g., !@#$%).', true);
                 return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = isSignUpMode ? 'A criar...' : 'A iniciar...';
            
            setTimeout(() => {
                // ** 4. SIMULAÇÃO DE SUCESSO E ARMAZENAMENTO **
                
                const userName = isSignUpMode ? name : 'Utilizador';
                const action = isSignUpMode ? 'Criada' : 'Iniciada';
                
                if (isSignUpMode) {
                    registerNewEmail(email); // Regista o novo email
                }

                // Cria o objeto de utilizador sem moradas pré-populadas
                const user = {
                    name: userName,
                    email: email,
                    isLoggedIn: true,
                    shippingAddress: '', 
                    billingAddress: ''
                };

                // Guarda os dados de login no localStorage
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(user));

                const message = isSignUpMode 
                    ? `A conta para ${email} foi criada com sucesso! Aceder ao perfil...`
                    : `Sessão iniciada com sucesso para ${userName}! Aceder ao perfil...`;
                    
                showCustomAlert(`${action} com Sucesso`, message);

                // ** 5. ATUALIZAÇÃO DA VISTA **
                document.getElementById('email-form').reset();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Iniciar Sessão';
                checkAuthStatus(); // Mostra a página de perfil
                
            }, 1500); // 1.5s de simulação
        }

        // Simulação do login com Google - AGORA APENAS ALERTA
        function handleGoogleLogin() {
            const googleBtn = document.getElementById('google-login-btn');
            googleBtn.disabled = true;
            googleBtn.textContent = 'A ligar...';
            
            setTimeout(() => {
                
                showCustomAlert(
                    'Aviso de Funcionalidade', 
                    'A funcionalidade de "Continuar com Google" não está disponível neste protótipo.'
                );

                googleBtn.disabled = false;
                googleBtn.textContent = 'Continuar com Google';

            }, 2000); // 2s de simulação
        }

        // Inicialização
        window.onload = function() {
            checkAuthStatus(); // Verifica se o utilizador já está autenticado
        };
    </script>
</body>
</html>